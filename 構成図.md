# 子ども見守りダイジェスト - システム構成図

## 概要
動画をアップロードして、フレーム抽出、画像解析、ベストショット選定、日記生成を行うStreamlitアプリケーション。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                        Streamlit UI                              │
│                    (streamlit_app.py)                           │
│  - 動画アップロード                                              │
│  - パイプライン実行                                              │
│  - 結果表示（ベストショット、日記）                              │
│  - デバッグビュー（中間生成物確認）                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    パイプライン処理                              │
└─────────────────────────────────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ 動画処理      │ │ データ管理    │ │ LLM処理      │
│              │ │              │ │              │
│ - video_     │ │ - paths.py   │ │ - model_     │
│   loader.py  │ │ - schemas.py │ │   loader.py  │
│ - frame_     │ │ - jsonl_io.py│ │ - vision_    │
│   extractor  │ │ - manifest_  │ │   captioner  │
│ - frame_     │ │   builder.py │ │ - diary_     │
│   preprocessor│ │              │ │   generator  │
└──────────────┘ └──────────────┘ └──────────────┘
         │               │               │
         └───────────────┼───────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ベストショット選定                            │
│                  (bestshot_scorer.py)                           │
└─────────────────────────────────────────────────────────────────┘
```

## モジュール構成

### 1. フロントエンド層

#### `streamlit_app.py`
- **役割**: Streamlit UIのメインアプリケーション
- **機能**:
  - 動画ファイルのアップロード
  - パイプライン全体の実行制御
  - ベストショット画像の表示
  - 日記テキストの表示
  - デバッグビュー（中間生成物の確認）
- **依存**: 全モジュール

### 2. 動画処理層

#### `video_loader.py`
- **役割**: 動画ファイルの保存とvideo_id生成
- **機能**:
  - アップロードされた動画を保存
  - タイムスタンプベースのvideo_id生成
- **出力**: `outputs/raw_videos/{video_id}.mp4`

#### `frame_extractor.py`
- **役割**: 動画から一定間隔でフレーム画像を抽出
- **機能**:
  - OpenCVを使用したフレーム抽出
  - 設定された間隔（デフォルト5秒）ごとに抽出
  - FrameMetaオブジェクトの生成
- **入力**: 動画ファイル
- **出力**: `outputs/frames/{video_id}/{video_id}_f{index:05d}.png`

#### `frame_preprocessor.py`
- **役割**: 抽出フレームの前処理と品質チェック
- **機能**:
  - 画像のリサイズ（長辺640px）
  - 暗さ判定（`is_too_dark`）
  - ブレ判定（`is_blurry`）
- **入力**: FrameMetaリスト
- **出力**: 更新されたFrameMetaリスト

### 3. データ管理層

#### `paths.py`
- **役割**: ファイルパスとディレクトリ構造の一元管理
- **機能**:
  - 各種ディレクトリ・ファイルパスの生成関数
  - 命名規則の統一
- **主要パス**:
  - `outputs/raw_videos/` - 元動画
  - `outputs/frames/{video_id}/` - 抽出フレーム
  - `outputs/manifests/` - マニフェストJSONL
  - `outputs/analysis/` - 画像解析結果JSONL
  - `outputs/bestshots/{video_id}/` - ベストショット画像・メタ
  - `outputs/diary/` - 日記Markdown

#### `schemas.py`
- **役割**: データ構造の型定義
- **主要クラス**:
  - `FrameMeta`: LLM解析前のフレーム情報
  - `FrameAnalysis`: LLM解析後のフレーム情報（caption, tags, scores等）
  - `BestShotMeta`: ベストショットのメタ情報
  - `AlertEvent`: 異常検知イベント（将来用）

#### `jsonl_io.py`
- **役割**: JSONLファイルの読み書きヘルパー
- **機能**:
  - dataclassとの相互変換
  - JSONL形式での保存・読み込み

#### `manifest_builder.py`
- **役割**: フレームマニフェストの作成
- **機能**:
  - FrameMetaリストをJSONL形式で保存
- **出力**: `outputs/manifests/{video_id}_frames_manifest.jsonl`

### 4. LLM処理層

#### `config_loader.py`
- **役割**: 設定ファイルの読み込み
- **機能**:
  - `config/settings.yaml`からアプリ設定を読み込み
  - `config/models.yaml`からモデル設定を読み込み
- **設定項目**:
  - データ保存先、フレーム間隔、ベストショット最大枚数
  - 日記の文字数制限、言語設定
  - 各役割（vision_caption, diary_writer）のモデル設定

#### `secrets_helper.py`
- **役割**: APIキーの初期化
- **機能**:
  - 環境変数、Colab userdata、Streamlit secretsからAPIキーを取得
  - Gemini APIキー、SambaNova APIキーの初期化

#### `model_loader.py`
- **役割**: 役割ごとのモデル設定とクライアントの管理
- **機能**:
  - `models.yaml`から役割（role）ごとの設定を取得
  - バックエンド（gemini/sambanova/local/dummy）に応じたクライアント生成
  - モデルキャッシュ管理
- **対応バックエンド**:
  - `gemini`: Google Gemini API
  - `sambanova`: SambaNova API (Llama)
  - `local`: ローカルモデル（未実装）
  - `dummy`: ダミー実装（LLM無し）

#### `prompt_templates.py`
- **役割**: 各LLMタスク用のプロンプトテンプレート
- **機能**:
  - `build_vision_caption_prompt()`: 画像解析用プロンプト
  - `build_diary_prompt()`: 日記生成用プロンプト

#### `vision_captioner.py`
- **役割**: フレーム画像の解析（キャプション、タグ、スコア生成）
- **機能**:
  - マニフェストからFrameMetaを読み込み
  - 各フレームをVisionモデル（Gemini/dummy）で解析
  - FrameAnalysisオブジェクトを生成してJSONL保存
- **入力**: `outputs/manifests/{video_id}_frames_manifest.jsonl`
- **出力**: `outputs/analysis/{video_id}_analysis.jsonl`
- **解析内容**:
  - caption（画像の説明）
  - tags（タグ配列）
  - scores（cuteness, interesting, representative）
  - has_child, num_children, main_subject
  - bbox（バウンディングボックス）

#### `diary_generator.py`
- **役割**: 1日のミニ日記テキスト生成
- **機能**:
  - FrameAnalysisのJSONLを読み込み
  - Textモデル（Gemini/SambaNova/dummy）で日記生成
  - Markdownファイルとして保存
- **入力**: `outputs/analysis/{video_id}_analysis.jsonl`
- **出力**: `outputs/diary/{video_id}_diary.md`
- **対応バックエンド**:
  - `gemini`: Gemini Textモデル
  - `sambanova`: SambaNova (Llama) Textモデル
  - `dummy`: 簡易な日記文を組み立て

### 5. ベストショット選定層

#### `bestshot_scorer.py`
- **役割**: ベストショットの選定と画像コピー
- **機能**:
  - FrameAnalysisからスコアを計算
  - スコア順にソートして上位N枚を選定
  - ベストショット画像をコピー
  - メタ情報をJSONで保存
- **入力**: `outputs/analysis/{video_id}_analysis.jsonl`
- **出力**:
  - `outputs/bestshots/{video_id}/{video_id}_best_{rank:02d}.png`
  - `outputs/bestshots/{video_id}/{video_id}_bestshots.json`

### 6. ユーティリティ層

#### `inspection.py`
- **役割**: デバッグ・検査用のユーティリティ
- **機能**: フレームのランダムサンプル表示

#### `alert_analyzer.py`
- **役割**: 異常検知分析（将来用）
- **機能**: AlertEventの生成と分析

## データフロー

```
1. 動画アップロード
   ↓
2. 動画保存 (video_loader.py)
   outputs/raw_videos/{video_id}.mp4
   ↓
3. フレーム抽出 (frame_extractor.py)
   outputs/frames/{video_id}/{video_id}_f{index:05d}.png
   ↓
4. フレーム前処理 (frame_preprocessor.py)
   FrameMetaリスト（is_blurry, is_too_darkフラグ付き）
   ↓
5. マニフェスト作成 (manifest_builder.py)
   outputs/manifests/{video_id}_frames_manifest.jsonl
   ↓
6. 画像解析 (vision_captioner.py)
   - Gemini/dummyで各フレームを解析
   outputs/analysis/{video_id}_analysis.jsonl
   ↓
7. ベストショット選定 (bestshot_scorer.py)
   outputs/bestshots/{video_id}/{video_id}_best_{rank:02d}.png
   outputs/bestshots/{video_id}/{video_id}_bestshots.json
   ↓
8. 日記生成 (diary_generator.py)
   outputs/diary/{video_id}_diary.md
```

## 設定ファイル

### `config/settings.yaml`
- データ保存先
- フレーム抽出間隔
- ベストショット最大枚数
- 日記の文字数制限・言語設定

### `config/models.yaml`
- 役割ごとのモデル設定
  - `vision_caption`: 画像解析用モデル
  - `diary_writer`: 日記生成用モデル
- 各役割の設定:
  - `backend`: gemini/sambanova/local/dummy
  - `model_name`: モデル名
  - `type`: vision/text

## 依存関係

```
streamlit_app.py
  ├─ config_loader.py
  ├─ paths.py
  ├─ video_loader.py
  ├─ frame_extractor.py
  ├─ frame_preprocessor.py
  ├─ manifest_builder.py
  ├─ vision_captioner.py
  ├─ bestshot_scorer.py
  ├─ diary_generator.py
  ├─ inspection.py
  └─ jsonl_io.py

vision_captioner.py
  ├─ model_loader.py
  ├─ prompt_templates.py
  ├─ schemas.py
  ├─ paths.py
  └─ jsonl_io.py

diary_generator.py
  ├─ model_loader.py
  ├─ prompt_templates.py
  ├─ schemas.py
  ├─ paths.py
  └─ jsonl_io.py

model_loader.py
  ├─ config_loader.py
  └─ secrets_helper.py
```

## 外部依存

- **Streamlit**: UIフレームワーク
- **OpenCV**: 動画処理・画像処理
- **Pillow**: 画像処理
- **google-genai**: Gemini API
- **sambanova**: SambaNova API
- **PyYAML**: 設定ファイル読み込み

